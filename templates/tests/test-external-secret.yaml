{{- if and .Values.tests.enabled .Values.oauth2Proxy.enabled .Values.oauth2Proxy.externalSecret.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-test-external-secret"
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  serviceAccountName: {{ .Release.Name }}-test-sa
  containers:
    - name: kubectl
      image: {{ .Values.tests.kubectlImage }}
      command: ['sh', '-c']
      args:
        - |
          set -e
          echo "Testing ExternalSecret configuration..."

          SECRET_NAME="{{ .Values.oauth2Proxy.externalSecret.secretName }}"
          ES_NAME="${SECRET_NAME}-external-secret"

          echo "Looking for ExternalSecret: $ES_NAME"

          # Check if ExternalSecret exists
          if kubectl get externalsecret "$ES_NAME" -n {{ .Release.Namespace }} > /dev/null 2>&1; then
            echo "✓ ExternalSecret $ES_NAME exists"
          else
            echo "✗ ExternalSecret $ES_NAME not found"
            exit 1
          fi

          # Check target secret name
          TARGET_SECRET=$(kubectl get externalsecret "$ES_NAME" -n {{ .Release.Namespace }} -o jsonpath='{.spec.target.name}')
          if [ "$TARGET_SECRET" = "$SECRET_NAME" ]; then
            echo "✓ Target secret name is correct: $SECRET_NAME"
          else
            echo "✗ Target secret name mismatch. Expected: $SECRET_NAME, Got: $TARGET_SECRET"
            exit 1
          fi

          # Check secret store reference
          if kubectl get externalsecret "$ES_NAME" -n {{ .Release.Namespace }} -o yaml | grep -q "name: gcp-sm-cluster-secret-store"; then
            echo "✓ SecretStore reference is configured"
          else
            echo "✗ SecretStore reference not found"
            exit 1
          fi

          # Check GCP Secret Manager key
          if kubectl get externalsecret "$ES_NAME" -n {{ .Release.Namespace }} -o yaml | grep -q "key: {{ .Values.oauth2Proxy.externalSecret.externalSecretKey }}"; then
            echo "✓ GCP Secret Manager key is configured: {{ .Values.oauth2Proxy.externalSecret.externalSecretKey }}"
          else
            echo "✗ GCP Secret Manager key not found"
            exit 1
          fi

          echo ""
          echo "ExternalSecret tests passed!"
{{- end }}

